import os
import re

def load_all_models_using_pipeline_reader(base_dir="notebooks/models"):
    models = []

    print(f"Scanning base directory: {base_dir}")

    for root, dirs, files in os.walk(base_dir):
        if "trained model.pkl" in files:
            model_path = os.path.join(root, "trained model.pkl")
            print(f"\nFound model file: {model_path}")

            # Extract region and model_type
            match_model_info = re.search(r"(aim|ain)_([a-z]{2})_([a-z]+)", root)
            if not match_model_info:
                print("Could not extract region/model_type from path.")
                continue

            _, region, model_type = match_model_info.groups()
            print(f"Extracted region: {region}, model_type: {model_type}")

            # Extract product
            match_product = re.search(r'/HAS/([^/]+)/', root.replace("\\", "/"))
            if not match_product:
                print("Could not extract product name from path.")
                continue

            product = match_product.group(1)
            print(f"Extracted product: {product}")

            # Build path to pass into read_intermediate_output
            dag_id = root.split("/notebooks/")[-1].split("/")[0]
            name = "/".join(root.split("/notebooks/")[-1].split("/")[1:]) + "/trained model.pkl"

            try:
                model = read_intermediate_output(dag_id=dag_id, name=name, suffix="pkl", as_pandas=False)
                print(f"Model loaded successfully via read_intermediate_output: {name}")
                models.append({
                    "region": region,
                    "model_type": model_type,
                    "product": product,
                    "model_path": name,
                    "model": model
                })
            except Exception as e:
                print(f"Failed to load model from {name}: {e}")

    print(f"\nTotal models loaded: {len(models)}")
    return models
